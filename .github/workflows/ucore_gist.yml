name: Upload Ignition files to gist

on:
  workflow_dispatch:
  push:
    paths:
      - "butane/**"
    branches:
      - "main"
  pull_request:
    paths:
      - "butane/**"

# Cancel previous runs of the same workflow on the same branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ignition:
    name: Build Ignition files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install dependencies
        shell: bash
        run: |
          sudo parallel --xapply curl -fsSL -O /usr/local/bin/{1} https://github.com/{2}/{1}/releases/latest/download/{1}{3} ::: yq butane ::: mikefarah coreos ::: _linux_amd64 -x86_64-unknown-linux-gnu
          sudo chmod +x /usr/local/bin/yq /usr/local/bin/butane
      - name: Build Ignition files
        shell: bash
        run: env CORE_PASSHASH='${{ secrets.CORE_PASSHASH }}' ./butane/build.sh
      - name: Gist Repo Sync
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: pentatonicfunk/action-gist-repo-sync@v1
        with:
          gist_token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          source_path: butane/output
