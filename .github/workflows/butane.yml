# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Build butane files

# cSpell:ignore xapply
# cSpell:dictionaries shellscript

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
  pull_request:

# Cancel previous runs of the same workflow on the same branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  filter:
    name: Filter unnecessary runs
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      butane: ${{ steps.changes.outputs.butane }}
      github: ${{ steps.changes.outputs.github }}
      continue: ${{ steps.continue.outputs.continue }}
    steps:
      - name: Checkout repository
        uses: &checkout actions/checkout@v5
      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            github:
              - '.github/workflows/butane.yml'
            butane:
              - 'butane/**'
      - id: continue
        name: Determine if build is needed
        env:
          CHANGED_GITHUB: ${{ steps.changes.outputs.github }}
          WORKFLOW_DISPATCH: ${{ github.event_name == 'workflow_dispatch' }}
          CHANGED_CONTAINER: ${{ steps.changes.outputs.butane }}
        run: |
          set -euo pipefail

          if [ WORKFLOW_DISPATCH == 'true' ] \
            || [ "$CHANGED_GITHUB" == 'true' ] \
            || [ "$CHANGED_CONTAINER" == 'true' ]; then
            echo "Changes detected, proceed with build"
            echo "continue=true" >> $GITHUB_OUTPUT
          else
            echo "No relevant changes detected, skip build"
            echo "continue=false" >> $GITHUB_OUTPUT
          fi

  build-ignition:
    if: needs.filter.outputs.continue == 'true' && !cancelled()
    needs: [filter]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: *checkout
      - name: Install dependencies
        shell: bash
        run: |
          sudo parallel --xapply curl -fsSL -o /usr/local/bin/{1} https://github.com/{2}/{1}/releases/latest/download/{1}{3} \
            ::: yq butane ::: mikefarah coreos ::: _linux_amd64 -x86_64-unknown-linux-gnu
          sudo chmod +x /usr/local/bin/yq /usr/local/bin/butane
      - name: Build butane files
        shell: bash
        run: env CORE_PASSHASH='${{ secrets.CORE_PASSHASH }}' ./butane/build.sh
      - name: Upload ignition files to Gist
        shell: bash
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          set -euxo pipefail

          gist="$(mktemp -d "${TMPDIR:-/tmp}/ist.XXXXXX")"
          trap 'rm -rf "$gist"' EXIT

          pushd "$gist"

          git init
          git config --local user.name "$GITHUB_ACTOR"
          git config --local user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git remote add origin 'https://${{ secrets.GIST_TOKEN }}@gist.github.com/${{ secrets.GIST_ID }}.git'
          git fetch -apP --all
          git checkout main

          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          popd

          rsync -aP butane/output/ "$gist/"

          pushd "$gist"

          git add -A
          if ! git diff-index --quiet HEAD --; then
            git commit -am "Update ignition files"
            git push -u origin main
          fi

  check:
    if: ${{ always() }}
    name: Butane result
    needs: [build-ignition]
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Check result
        env:
          RESULT: ${{ needs.build-ignition.result }}
        run: |
          if [ "$RESULT" == "success" ] || [ "$RESULT" == "skipped" ]; then
            exit 0
          else
            exit 1
          fi
